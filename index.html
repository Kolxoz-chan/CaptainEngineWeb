<!doctype html>
<html lang="ru">
<head>
	<meta charset="utf-8" />
	<title>Полигон для теста</title>
	<script src="scripts/objects.js"></script>
	<script src="scripts/gui.js"></script>
	<script src="scripts/base_components.js"></script>
	<script src="scripts/action_components.js"></script>
	<script src="scripts/components.js"></script>
	<script src="scripts/engine.js"></script>
</head>
	<body>
	
		<div id="game-block"><div>
		<script>
		
		/* --- Init game -------------------------------------------------------  */
		Game.init("game-block", 800, 600, "background-color: black; margin: auto; display: block;");
		Game.setEventHandlers(['keydown', 'keyup', 'mousedown', 'mouseup', "mousemove"])
		Game.setDefaultCursor("none")
		Game.setResizable(true)
		Game.resetCursor()
		
		/* --- Load resources --------------------------------------------------- */
		Resources.textures_dir = "https://raw.githubusercontent.com/Kolxoz-chan/MalgrandaLando/main/textures/"
		//Resources.textures_dir = "file:///C:/Users/Сергей/Desktop/MalgrandaLando/textures/"
		Resources.loadTexture("target", "target.png")
		Resources.loadTexture("simple_sight", "simple_sight.png")
		
		/* Load target prefabs  */
		let prefab = new Prefab();
		prefab.addComponent("LifeComponent", {"max_value" : 1});
		prefab.addComponent("TransformComponent", {"size" : new Vector2(48, 48)});
		prefab.addComponent("ImageComponent", {"texture" : "target"});
		prefab.addComponent("CircleColiderComponent");
		prefab.addComponent("DamageClickableComponent", {"global_cursor" : false});
		prefab.addComponent("RespawnComponent", {"time" : 3.0});
		prefab.addComponent("DeathDisolveComponent");
		prefab.addComponent("PathMovingComponent");
		prefab.addComponent("TargetBonusClickableComponent", {"global_cursor" : false, "target" : "player"});
		Resources.addPrefab("simple_target", prefab);
		
		/* Score indicator */
		prefab = new Prefab();
		prefab.addComponent("TransformComponent");
		prefab.addComponent("TextComponent", {"line_width" : 5.0, "font" : new Font("Arial", 24)});
		//prefab.addComponent("DeathDisolveComponent");
		prefab.addComponent("TemporaryComponent", {"time" : 3.0});
		Resources.addPrefab("score_indicator", prefab);
		
		/* --- Load GUI --------------------------------------------------------- */
		let form = new Form();
		form.setStyle({"background_style" : null, "border_color" : null})
		form.setPositionType(Widget.RELATIVE, Widget.RELATIVE)
		form.setPosition(new Vector2(0.5, 0.5));
		form.setSizeType(Widget.RELATIVE, Widget.RELATIVE)
		form.setSize(new Vector2(1.0, 1.0));
		form.onUpdate = function()
		{
			let player = Game.getObject("player")
			let score = player.getComponent("ScoreComponent").getValue()
			let time = player.getComponent("TimerComponent").getTime()
			
			time = Math.ceil(time);
			let minutes = Math.floor(time / 60);
			let seconds = Math.floor(time % 60);
			
			if(minutes < 10) minutes = "0" + minutes.toString();
			if(seconds < 10) seconds = "0" + seconds.toString();

			this.layout.names["score_label"].setText(score)
			this.layout.names["timer_label"].setText(`${minutes}:${seconds}`)
		}
		Game.addWidget(form);
		
		let label = new Label("", "score_label")
		label.setStyle({"font" : new Font("Arial", 32), "background_style" : new Color(255, 140, 0)})
		label.setPositionType(Widget.RELATIVE, Widget.RELATIVE)
		label.setPosition(new Vector2(0.01, 0.01));
		form.layout.addWidget(label);
		
		label = new Label("", "timer_label")
		label.setStyle({"font" : new Font("Arial", 32), "background_style" : new Color(255, 255, 0)})
		label.setPositionType(Widget.RELATIVE, Widget.RELATIVE)
		label.setPosition(new Vector2(0.5, 0.01));
		form.layout.addWidget(label);
		
		let pic = new Picture(new Texture("simple_sight"))
		pic.setPositionType(Widget.RELATIVE, Widget.RELATIVE)
		pic.setPosition(new Vector2(0.5, 0.5));
		pic.setSize(new Vector2(32, 32));
		form.layout.addWidget(pic);
		
		/* --- Load data -------------------------------------------------------- */
		let level = new Level("test_level")
		let layer = new ObjectsLayer("objects")
		level.addLayer(layer);
		Game.setLevel(level);
		
		/* Player */
		let ent = new Entity("player");
		ent.addComponent(new PunishmentMissclickComponent(), {"container" : "objects"});
		ent.addComponent(new CursoreWatcherComponent());
		ent.addComponent(new PlayerControlComponent());
		ent.addComponent(new ScoreIndicatorSpawner(), {"attribute" : "ScoreComponent", "prefab" : "score_indicator", "container" : "objects"});
		ent.addComponent(new ScoreComponent());
		ent.addComponent(new TimerComponent(), {"time" : 90, "action" : function()
		{
			
		}});
		layer.addObject(ent)
		
		/* Targets */
		let target = Resources.getPrefab("simple_target")
		layer.addObject(target.getEntity({
			"TransformComponent" : {"position" : new Vector2(48, 48)},
			"PathMovingComponent" : {"speed" : 120, "path" : [new Vector2(48, 48), new Vector2(600, 48), new Vector2(600, 400), new Vector2(48, 400)]}}))
			
		layer.addObject(target.getEntity({
			"TransformComponent" : {"position" : new Vector2(123, 67)},
			"PathMovingComponent" : {"speed" : 120, "path" : [new Vector2(123, 67), new Vector2(123, 600)]}}))
			
		layer.addObject(target.getEntity({
			"TransformComponent" : {"position" : new Vector2(56, 333)},
			"PathMovingComponent" : {"speed" : 120, "path" : [new Vector2(56, 333), new Vector2(700, 333)]}}))

		/* --- Start game -------------------------------------------------------- */
		Game.start();
		
		</script>
	</body>
</html>